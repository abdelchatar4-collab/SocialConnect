generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                             String              @id
  nom                            String
  prenom                         String
  dateNaissance                  DateTime?
  genre                          String?
  telephone                      String?
  email                          String?
  adresseId                      String?
  dateOuverture                  DateTime            @default(now())
  dateCloture                    DateTime?
  etat                           String              @default("Actif")
  antenne                        String?
  statutSejour                   String?
  nationalite                    String?
  trancheAge                     String?
  remarques                      String?             @db.Text
  hasPrevExp                     Boolean?
  langue                         String?
  premierContact                 String?
  prevExpCommentaire             String?             @db.Text
  prevExpDateReception           DateTime?
  prevExpDateRequete             DateTime?
  prevExpDateVad                 DateTime?
  prevExpDecision                String?
  secteur                        String?
  logementDetails                String?             @db.Text
  notesGenerales                 String?             @db.Text
  rgpdAttestationGeneratedAt     DateTime?
  gestionnaireId                 String?
  geographicalSectorId           Int?
  streetId                       Int?
  problematiquesDetails          String?             @db.Text
  informationImportante          String?             @db.Text
  partenaire                     String?
  afficherDonneesConfidentielles Boolean?            @default(false)
  donneesConfidentielles         String?             @db.Text
  annee                          Int
  dossierPrecedentId             String?
  prevExpAideJuridique           String?
  prevExpDateAudience            DateTime?
  serviceId                      String              @default("default")
  service                        Service             @relation(fields: [serviceId], references: [id])
  prevExpDateExpulsion           DateTime?
  prevExpDateJugement            DateTime?
  prevExpDateSignification       DateTime?
  prevExpDemandeCpas             String?
  prevExpEtatLogement            String?
  prevExpMaintienLogement        String?
  prevExpMotifRequete            String?
  prevExpNegociationProprio      String?
  prevExpNombreChambre           String?
  prevExpSolutionRelogement      String?
  prevExpTypeFamille             String?
  prevExpTypeRevenu              String?
  revenus                        String?
  situationProfessionnelle       String?
  prevExpDossierOuvert           String?
  mediationType                  String?
  mediationDemandeur             String?
  mediationPartieAdverse         String?
  mediationStatut                String?
  mediationDescription           String?             @db.Text
  createdAt                      DateTime            @default(now())
  createdBy                      String?
  updatedAt                      DateTime?           @updatedAt
  updatedBy                      String?
  documents                      Document[]
  adresse                        Adresse?            @relation(fields: [adresseId], references: [id], onDelete: Cascade)
  dossierPrecedent               User?               @relation("HistoriqueDossier", fields: [dossierPrecedentId], references: [id], onUpdate: SetNull)
  dossierSuivant                 User[]              @relation("HistoriqueDossier")
  geographicalSector             GeographicalSector? @relation(fields: [geographicalSectorId], references: [id])
  gestionnaire                   Gestionnaire?       @relation(fields: [gestionnaireId], references: [id])
  street                         Street?             @relation(fields: [streetId], references: [id])
  actions                        ActionSuivi[]       @relation("ActionSuiviToUser")
  problematiques                 Problematique[]

  @@index([serviceId])
  @@index([nom, prenom])
  @@index([gestionnaireId], map: "User_gestionnaireId_fkey")
  @@index([adresseId], map: "User_adresseId_fkey")
  @@index([geographicalSectorId], map: "User_geographicalSectorId_fkey")
  @@index([streetId], map: "User_streetId_fkey")
  @@index([annee])
  @@index([dossierPrecedentId])
  @@map("User")
}

model Adresse {
  id         String  @id @default(cuid())
  rue        String?
  codePostal String?
  ville      String?
  pays       String? @default("Belgique")
  boite      String?
  numero     String?
  users      User[]

  @@map("adresses")
}

model Document {
  id        String   @id @default(uuid())
  nom       String
  type      String
  contenu   String?  @db.Text
  date      DateTime @default(now())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Document_userId_fkey")
}

model Problematique {
  id              String    @id @default(uuid())
  type            String
  detail          String?   @db.Text
  userId          String
  description     String?
  dateSignalement DateTime?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("problematiques")
}

model ActionSuivi {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  type        String
  partenaire  String?
  description String?
  userId      String
  user        User     @relation("ActionSuiviToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "actions_suivi_userId_fkey")
  @@map("actions_suivi")
}

model Gestionnaire {
  id               String  @id @default(uuid())
  nom              String?
  prenom           String
  email            String? @unique
  role             String  @default("USER")
  serviceId        String  @default("default")
  service          Service @relation(fields: [serviceId], references: [id])
  couleurMedaillon String? @db.LongText
  isActive         Boolean @default(true)
  lastActiveServiceId String? // Pour les Super Admins : dernier service visité
  horaireHabituel   Json?    // { name: string, start: string, end: string, pause: number, standardDuration: number }
  isGestionnaireDossier Boolean @default(true) // Si true, apparaît dans les dropdowns d'assignation de dossiers
  prestations      Prestation[]
  users            User[]

  soldeConges      SoldeConge[]
  conges           Conge[]
  @@index([serviceId])
  @@map("gestionnaires")
}

model DropdownOption {
  id        String  @id @default(cuid())
  value     String
  label     String
  type      String  @default("unknown")
  serviceId String  @default("default")
  service   Service @relation(fields: [serviceId], references: [id])

  @@unique([type, value, serviceId])
  @@index([serviceId])
  @@map("dropdown_options")
}

model GeographicalSector {
  id          Int      @id @default(autoincrement())
  nom         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  streets     Street[]

  @@map("secteurs")
}

model Street {
  id                   Int                @id @default(autoincrement())
  nom                  String
  geographicalSectorId Int
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  users                User[]
  geographicalSector   GeographicalSector @relation(fields: [geographicalSectorId], references: [id])

  @@index([geographicalSectorId], map: "Street_geographicalSectorId_fkey")
  @@map("rues")
}

model Settings {
  id                 String   @id @default(uuid())
  serviceId          String?
  // service            Service? @relation(fields: [serviceId], references: [id])
  serviceName        String   @default("LE PÔLE ACCUEIL SOCIAL DES QUARTIERS")
  logoUrl            String?
  primaryColor       String   @default("#1e3a8a")
  headerSubtitle     String   @default("PORTAIL DE GESTION")
  showCommunalLogo   Boolean  @default(true)
  requiredFields     String   @db.LongText
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  colleagueBirthdays String   @db.LongText
  enableBirthdays    Boolean  @default(false)
  activeHolidayTheme String   @default("NONE")
  availableYears     String   @db.LongText

  // AI Settings
  aiEnabled              Boolean @default(true)
  aiProvider             String  @default("ollama")
  aiEndpoint             String  @default("http://192.168.2.147:11434")
  aiModel                String  @default("qwen2.5:3b")
  aiTemperature          Float   @default(0.7)
  aiGroqApiKey           String? @db.VarChar(255)
  aiGroqModel            String  @default("llama-3.1-8b-instant")
  aiUseKeyPool           Boolean @default(false)
  aiEnableAnalysis       Boolean @default(true)
  aiAnalysisTemperature  Float   @default(0)
  aiCustomAnalysisPrompt String? @db.Text

  // Feature Toggles (Modules à la carte)
  enabledModules         Json?    // Stucture: { "housing": true, "stats": true, ... }

  // Column Visibility Settings (per service)
  visibleColumns         Json?    // Structure: { "nom": true, "telephone": true, ... }

  // Form Section Visibility Settings (per service)
  visibleFormSections    Json?    // Structure: { "identity": true, "housing": false, ... }

  // Document Settings (per service)
  docRetentionPeriod       String?  @default("3 ans")
  docServiceAddress        String?
  docServiceCity           String?
  docServicePhone          String?
  docFooterText            String?
  docRgpdTitle             String?  @db.Text
  docRgpdSections          String?  @db.LongText  // JSON: { "intro": true, "pourquoi": true, ... }
  docUserProfileSections   String?  @db.LongText  // JSON: { "identite": true, "notes": false, ... }
  docAntenneAddresses      String?  @db.LongText  // JSON: { "cureghem": { rue: "...", cp: "..." }, ... }
  absenceNotificationEmail String?
  sharepointUrl            String?  @db.Text
  sharepointUrlAdmin       String?  @db.Text

  @@index([serviceId])
  @@map("settings")
}

model ApiKey {
  id               String    @id @default(cuid())
  provider         String    @default("groq")
  key              String    @db.VarChar(255)
  label            String
  isActive         Boolean   @default(true)
  lastUsedAt       DateTime?
  requestsToday    Int       @default(0)
  isRateLimited    Boolean   @default(false)
  rateLimitedUntil DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("api_keys")
}

model Service {
  id          String   @id @default(cuid())
  slug        String   @unique // ex: "vie-precaire", "logement"
  name        String // ex: "Vie Précaire"
  cluster     String? // ex: "Pôle Inclusion" (Groupement)
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  gestionnaires   Gestionnaire[]
  dropdownOptions DropdownOption[]
  prestations     Prestation[]
  holidays        Holiday[]
  // settings      Settings[]
}

model Prestation {
  id               String       @id @default(cuid())
  date             DateTime
  heureDebut       String       // "HH:mm"
  heureFin         String       // "HH:mm"
  pause            Int          @default(0) // Minutes
  dureeNet         Int          @default(0) // Minutes
  isOvertime       Boolean      @default(false) // If after 19:00
  bonis            Int          @default(0) // Minutes exceeding standard
  motif            String
  commentaire      String?      @db.Text
  gestionnaireId   String
  serviceId        String       @default("default")
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  gestionnaire     Gestionnaire @relation(fields: [gestionnaireId], references: [id])
  service          Service      @relation(fields: [serviceId], references: [id])

  @@index([gestionnaireId])
  @@index([serviceId])
  @@index([date])
  @@map("prestations")
}

model Holiday {
  id        String   @id @default(cuid())
  date      DateTime
  label     String
  year      Int
  serviceId String   @default("default")
  service   Service  @relation(fields: [serviceId], references: [id])

  @@unique([date, serviceId])
  @@index([serviceId])
  @@index([year])
  @@map("holidays")
}

model SoldeConge {
  id              String       @id @default(cuid())
  gestionnaireId  String
  gestionnaire    Gestionnaire @relation(fields: [gestionnaireId], references: [id], onDelete: Cascade)

  annee                Int      @default(2026)

  // Quotas en minutes (ex: 217h30 = 13050 minutes)
  vacancesAnnuelles    Int      @default(0) // VA
  consultationMedicale Int      @default(0) // CM
  forceMajeure         Int      @default(0) // FM
  congesReglementaires Int      @default(0) // CR
  creditHeures         Int      @default(0) // CH
  heuresSupplementaires Int     @default(0) // HS

  updatedAt            DateTime @updatedAt

  @@unique([gestionnaireId, annee])
  @@map("solde_conges")
}

model Conge {
  id             String       @id @default(cuid())
  gestionnaireId String
  gestionnaire   Gestionnaire @relation(fields: [gestionnaireId], references: [id], onDelete: Cascade)
  startDate      DateTime
  endDate        DateTime
  type           String       // "Vacances", "Maladie", "Force Majeure", "Autre"
  reason         String?      @db.Text
  status         String       @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([gestionnaireId])
  @@map("conges")
}

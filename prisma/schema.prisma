// Copyright (C) 2025 ABDEL KADER CHATAR
// SocialConnect est un logiciel libre : vous pouvez le redistribuer et/ou le modifier selon les termes de la Licence Publique Générale GNU telle que publiée par la Free Software Foundation, soit la version 3 de la licence, soit (à votre convenance) toute version ultérieure.
//
// Ce programme est distribué dans l'espoir qu'il sera utile, mais SANS AUCUNE GARANTIE ; sans même la garantie implicite de COMMERCIALISATION ou d'ADÉQUATION À UN USAGE PARTICULIER. Voir la Licence Publique Générale GNU pour plus de détails.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String              @id
  nom                        String
  prenom                     String
  dateNaissance              DateTime?
  genre                      String?
  telephone                  String?
  email                      String?
  adresseId                  String?
  dateOuverture              DateTime            @default(now())
  dateCloture                DateTime?
  etat                       String              @default("Actif")
  antenne                    String?
  statutSejour               String?
  nationalite                String?
  trancheAge                 String?
  remarques                  String?             @db.Text
  hasPrevExp                 Boolean?
  langue                     String?
  situationProfessionnelle   String?
  revenus                    String?
  premierContact             String?
  prevExpCommentaire         String?             @db.Text
  prevExpDateReception       DateTime?
  prevExpDateRequete         DateTime?
  prevExpDateVad             DateTime?
  prevExpDateAudience        DateTime?
  prevExpDateSignification   DateTime?
  prevExpDateJugement        DateTime?
  prevExpDateExpulsion       DateTime?
  prevExpDossierOuvert       String?             // Nouveau champ: "OUI" ou "NON"
  prevExpDecision            String?
  prevExpDemandeCpas         String?
  prevExpNegociationProprio  String?
  prevExpSolutionRelogement  String?
  prevExpMaintienLogement    String?
  prevExpTypeFamille         String?
  prevExpTypeRevenu          String?
  prevExpEtatLogement        String?
  prevExpNombreChambre       String?
  prevExpAideJuridique       String?
  prevExpMotifRequete        String?
  secteur                    String?
  logementDetails            String?             @db.Text
  notesGenerales             String?             @db.Text
  rgpdAttestationGeneratedAt DateTime?
  gestionnaireId             String?
  geographicalSectorId       Int?
  streetId                   Int?
  problematiquesDetails      String?             @db.Text
  informationImportante      String?             @db.Text
  afficherDonneesConfidentielles Boolean?        @default(false)
  donneesConfidentielles     String?             @db.Text
  partenaire                 String?
  documents                  Document[]
  adresse                    Adresse?            @relation(fields: [adresseId], references: [id], onDelete: Cascade)
  geographicalSector         GeographicalSector? @relation(fields: [geographicalSectorId], references: [id])
  gestionnaire               Gestionnaire?       @relation(fields: [gestionnaireId], references: [id])
  street                     Street?             @relation(fields: [streetId], references: [id])
  actions                    ActionSuivi[]       @relation("ActionSuiviToUser")
  problematiques             Problematique[]

  // Champs pour la transition annuelle
  annee                      Int                 @default(2025)
  dossierPrecedentId         String?
  dossierPrecedent           User?               @relation("HistoriqueDossier", fields: [dossierPrecedentId], references: [id], onDelete: SetNull, onUpdate: SetNull)
  dossierSuivant             User[]              @relation("HistoriqueDossier")

  // Champs d'audit (traçabilité)
  createdBy                  String?             // Email de l'utilisateur qui a créé le dossier
  createdAt                  DateTime            @default(now())
  updatedBy                  String?             // Email de l'utilisateur qui a modifié le dossier
  updatedAt                  DateTime?           @updatedAt

  @@index([gestionnaireId], map: "User_gestionnaireId_fkey")
  @@index([adresseId], map: "User_adresseId_fkey")
  @@index([geographicalSectorId], map: "User_geographicalSectorId_fkey")
  @@index([streetId], map: "User_streetId_fkey")
  @@index([annee])
  @@index([dossierPrecedentId])
  @@map("User")
}

model Adresse {
  id         String  @id @default(cuid())
  rue        String?
  codePostal String?
  ville      String?
  pays       String? @default("Belgique")
  boite      String?
  numero     String?
  users      User[]

  @@map("adresses")
}

model Document {
  id        String   @id @default(uuid())
  nom       String
  type      String
  contenu   String?  @db.Text
  date      DateTime @default(now())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "Document_userId_fkey")
}

model Problematique {
  id              String    @id @default(uuid())
  type            String
  detail          String?   @db.Text
  userId          String
  description     String?
  dateSignalement DateTime?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("problematiques")
}

model ActionSuivi {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  type        String
  partenaire  String?
  description String?
  userId      String
  user        User     @relation("ActionSuiviToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "actions_suivi_userId_fkey")
  @@map("actions_suivi")
}

model Gestionnaire {
  id               String  @id @default(uuid())
  nom              String?
  prenom           String
  email            String  @unique
  role             String  @default("USER")
  couleurMedaillon String? @db.LongText
  users            User[]

  @@map("gestionnaires")
}

model DropdownOption {
  id    String @id @default(cuid())
  value String
  label String
  type  String @default("unknown")

  @@unique([type, value])
  @@map("dropdown_options")
}

model GeographicalSector {
  id          Int      @id @default(autoincrement())
  nom         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  streets     Street[]

  @@map("secteurs")
}

model Street {
  id                   Int                @id @default(autoincrement())
  nom                  String
  geographicalSectorId Int
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  users                User[]
  geographicalSector   GeographicalSector @relation(fields: [geographicalSectorId], references: [id])

  @@index([geographicalSectorId], map: "Street_geographicalSectorId_fkey")
  @@map("rues")
}

model Settings {
  id                  String   @id @default(uuid())
  serviceName         String   @default("LE PÔLE ACCUEIL SOCIAL DES QUARTIERS")
  logoUrl             String?
  primaryColor        String   @default("#1e3a8a")
  headerSubtitle      String   @default("PORTAIL DE GESTION")
  showCommunalLogo    Boolean  @default(true)
  requiredFields      Json     @default("[]")
  enableBirthdays     Boolean  @default(false)
  colleagueBirthdays  Json     @default("[]")
  activeHolidayTheme  String   @default("NONE") // Options: "NONE", "CHRISTMAS", "NEW_YEAR"
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("settings")
}

// API Keys for AI providers (Groq, OpenAI, etc.)
model ApiKey {
  id               String    @id @default(cuid())
  provider         String    @default("groq") // "groq", "openai", etc.
  key              String    @db.VarChar(255)
  label            String    // e.g., "Pauline", "Ahmed"
  isActive         Boolean   @default(true)
  lastUsedAt       DateTime?
  requestsToday    Int       @default(0)
  isRateLimited    Boolean   @default(false)
  rateLimitedUntil DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("api_keys")
}
